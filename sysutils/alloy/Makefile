COMMENT =	OpenTelemetry Collector for metrics and logs

# github.com/grafana/alloy uses too much ram to build on 32-bit
ONLY_FOR_ARCHS = aarch64 amd64 riscv64

V =		1.10.0
DISTNAME =	alloy+vendor-${V}
WRKDIST =	${WRKDIR}/alloy-${V}
EXTRACT_SUFX =	.tar.zst
PKGNAME =	alloy-${V}

SITES =		https://ports.lucasraab.me/

HOMEPAGE =	https://grafana.com/oss/alloy/

CATEGORIES =	sysutils

# Apache 2.0
PERMIT_PACKAGE =	Yes

WANTLIB +=	c pthread

MODULES =	lang/go

# alloy+vendor distfiles generated by fetching archive from
# https://github.com/grafana/alloy/archive/v$V/alloy-$V.tar.gz
# running `cd syntax; go mod tidy; go mod vendor; cd -` and 
# `go mod tidy; go mod vendor`.

MODGO_FLAGS +=	-ldflags="-w -X github.com/grafana/alloy/internal/build.Version=${V}"
MODGO_GO111MODULE =	on

do-build:
	cd ${WRKSRC} && ${MODGO_CMD} build ${MODGO_FLAGS} -o build/alloy .

do-install:
	${INSTALL_PROGRAM} ${WRKSRC}/build/alloy ${PREFIX}/bin
	${INSTALL_DATA_DIR} ${PREFIX}/share/examples/alloy
	${INSTALL_DATA} ${WRKSRC}/example-config.alloy \
		${PREFIX}/share/examples/alloy

.include <bsd.port.mk>
