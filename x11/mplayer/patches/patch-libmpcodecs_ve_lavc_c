Index: libmpcodecs/ve_lavc.c
--- libmpcodecs/ve_lavc.c.orig
+++ libmpcodecs/ve_lavc.c
@@ -152,7 +152,7 @@ static int lavc_param_video_global_header= 0;
 static int lavc_param_mv0_threshold = 256;
 static int lavc_param_refs = 1;
 static int lavc_param_b_sensitivity = 40;
-static int lavc_param_level = FF_LEVEL_UNKNOWN;
+static int lavc_param_level = AV_LEVEL_UNKNOWN;
 
 char *lavc_param_acodec = "mp2";
 int lavc_param_atag = 0;
@@ -721,13 +721,21 @@ static int put_image(struct vf_instance *vf, mp_image_
     pic->pict_type = is_forced_key_frame(pts) ? AV_PICTURE_TYPE_I : 0;
 
     if(lavc_param_interlaced_dct){
-        if((mpi->fields & MP_IMGFIELD_ORDERED) && (mpi->fields & MP_IMGFIELD_INTERLACED))
-            pic->top_field_first= !!(mpi->fields & MP_IMGFIELD_TOP_FIRST);
-        else
-            pic->top_field_first= 1;
+        if((mpi->fields & MP_IMGFIELD_ORDERED) && (mpi->fields & MP_IMGFIELD_INTERLACED)) {
+			if (!!(mpi->fields & MP_IMGFIELD_TOP_FIRST))
+				pic->flags |= MP_IMGFIELD_TOP_FIRST;
+			else
+				pic->flags &= ~MP_IMGFIELD_TOP_FIRST;
+        } else {
+			pic->flags |= MP_IMGFIELD_TOP_FIRST;
+		}
 
-        if(lavc_param_top!=-1)
-            pic->top_field_first= lavc_param_top;
+        if(lavc_param_top!=-1) {
+			if (lavc_param_top)
+				pic->flags |= MP_IMGFIELD_TOP_FIRST;
+			else
+				pic->flags &= ~MP_IMGFIELD_TOP_FIRST;
+		}
     }
 
     return encode_frame(vf, pic, pts) >= 0;
@@ -853,7 +861,7 @@ static void uninit(struct vf_instance *vf){
     av_freep(&lavc_venc_context->inter_matrix);
 
     if (lavc_venc_context->codec)
-        avcodec_close(lavc_venc_context);
+        avcodec_free_context(&lavc_venc_context);
 
     if(stats_file) fclose(stats_file);
 
